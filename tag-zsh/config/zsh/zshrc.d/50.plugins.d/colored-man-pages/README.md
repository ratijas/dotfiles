Shamelessly copied from oh-my-zsh, stripped down irrelevant parts, and
refactored.
